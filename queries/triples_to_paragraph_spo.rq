

SELECT
?s
?p
?s_str
?p_str
?o_str
(CONCAT("<", "?p_str, ">", " ", ?o_str) AS ?po_str)
{
    {
        SELECT
        ?s
        ?p
        (GROUP_CONCAT(?_o_str; separator=', '), " .\\n") AS ?o_str)
            WHERE {
                ?s ?p ?o .
                FILTER(?p NOT IN (rdfs:label))

                OPTIONAL {?o rdfs:label ?o_label}
                BIND(IF(isLiteral(?o), STR(?o), COALESCE(?o_label, STR(?o))) AS ?_o_str)

                BIND(CONCAT("<", ?p_str, "> <", ?o_str, "> ") AS ?po_str)

            }
            GROUP BY ?s ?s_str ?p ?p_str
            ORDER BY ?s ?p

    }
    OPTIONAL {?s rdfs:label ?s_label}
    OPTIONAL {?p rdfs:label ?p_label}
    BIND(COALESCE(?s_label, STR(?s)) AS ?s_str)
    BIND(IF(?p = rdf:type, "is a", COALESCE(?p_label, STR(?p))) AS ?p_str)
}
ORDER BY ?s ?p_str
